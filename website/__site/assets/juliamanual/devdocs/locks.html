<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Proper maintenance and care of multi-threading locks Â· The Julia Language</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link href="../assets/julia-manual.css" rel="stylesheet" type="text/css"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar">
    <p style="text-align: center;">JuliaMono edition</p>
<a class="docs-logo" href="../index.html"><img class="docs-light-only" src="../assets/logo.svg" alt="The Julia Language logo"/><img class="docs-dark-only" src="../assets/logo-dark.svg" alt="The Julia Language logo"/></a><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">Home</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Manual</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../manual/getting-started.html">Getting Started</a></li><li><a class="tocitem" href="../manual/variables.html">Variables</a></li><li><a class="tocitem" href="../manual/integers-and-floating-point-numbers.html">Integers and Floating-Point Numbers</a></li><li><a class="tocitem" href="../manual/mathematical-operations.html">Mathematical Operations and Elementary Functions</a></li><li><a class="tocitem" href="../manual/complex-and-rational-numbers.html">Complex and Rational Numbers</a></li><li><a class="tocitem" href="../manual/strings.html">Strings</a></li><li><a class="tocitem" href="../manual/functions.html">Functions</a></li><li><a class="tocitem" href="../manual/control-flow.html">Control Flow</a></li><li><a class="tocitem" href="../manual/variables-and-scoping.html">Scope of Variables</a></li><li><a class="tocitem" href="../manual/types.html">Types</a></li><li><a class="tocitem" href="../manual/methods.html">Methods</a></li><li><a class="tocitem" href="../manual/constructors.html">Constructors</a></li><li><a class="tocitem" href="../manual/conversion-and-promotion.html">Conversion and Promotion</a></li><li><a class="tocitem" href="../manual/interfaces.html">Interfaces</a></li><li><a class="tocitem" href="../manual/modules.html">Modules</a></li><li><a class="tocitem" href="../manual/documentation.html">Documentation</a></li><li><a class="tocitem" href="../manual/metaprogramming.html">Metaprogramming</a></li><li><a class="tocitem" href="../manual/arrays.html">Multi-dimensional Arrays</a></li><li><a class="tocitem" href="../manual/missing.html">Missing Values</a></li><li><a class="tocitem" href="../manual/networking-and-streams.html">Networking and Streams</a></li><li><a class="tocitem" href="../manual/parallel-computing.html">Parallel Computing</a></li><li><a class="tocitem" href="../manual/running-external-programs.html">Running External Programs</a></li><li><a class="tocitem" href="../manual/calling-c-and-fortran-code.html">Calling C and Fortran Code</a></li><li><a class="tocitem" href="../manual/handling-operating-system-variation.html">Handling Operating System Variation</a></li><li><a class="tocitem" href="../manual/environment-variables.html">Environment Variables</a></li><li><a class="tocitem" href="../manual/embedding.html">Embedding Julia</a></li><li><a class="tocitem" href="../manual/code-loading.html">Code Loading</a></li><li><a class="tocitem" href="../manual/profile.html">Profiling</a></li><li><a class="tocitem" href="../manual/stacktraces.html">Stack Traces</a></li><li><a class="tocitem" href="../manual/performance-tips.html">Performance Tips</a></li><li><a class="tocitem" href="../manual/workflow-tips.html">Workflow Tips</a></li><li><a class="tocitem" href="../manual/style-guide.html">Style Guide</a></li><li><a class="tocitem" href="../manual/faq.html">Frequently Asked Questions</a></li><li><a class="tocitem" href="../manual/noteworthy-differences.html">Noteworthy Differences from other Languages</a></li><li><a class="tocitem" href="../manual/unicode-input.html">Unicode Input</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Base</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../base/base.html">Essentials</a></li><li><a class="tocitem" href="../base/collections.html">Collections and Data Structures</a></li><li><a class="tocitem" href="../base/math.html">Mathematics</a></li><li><a class="tocitem" href="../base/numbers.html">Numbers</a></li><li><a class="tocitem" href="../base/strings.html">Strings</a></li><li><a class="tocitem" href="../base/arrays.html">Arrays</a></li><li><a class="tocitem" href="../base/parallel.html">Tasks</a></li><li><a class="tocitem" href="../base/multi-threading.html">Multi-Threading</a></li><li><a class="tocitem" href="../base/constants.html">Constants</a></li><li><a class="tocitem" href="../base/file.html">Filesystem</a></li><li><a class="tocitem" href="../base/io-network.html">I/O and Network</a></li><li><a class="tocitem" href="../base/punctuation.html">Punctuation</a></li><li><a class="tocitem" href="../base/sort.html">Sorting and Related Functions</a></li><li><a class="tocitem" href="../base/iterators.html">Iteration utilities</a></li><li><a class="tocitem" href="../base/c.html">C Interface</a></li><li><a class="tocitem" href="../base/libc.html">C Standard Library</a></li><li><a class="tocitem" href="../base/stacktraces.html">StackTraces</a></li><li><a class="tocitem" href="../base/simd-types.html">SIMD Support</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Standard Library</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../stdlib/Base64.html">Base64</a></li><li><a class="tocitem" href="../stdlib/CRC32c.html">CRC32c</a></li><li><a class="tocitem" href="../stdlib/Dates.html">Dates</a></li><li><a class="tocitem" href="../stdlib/DelimitedFiles.html">Delimited Files</a></li><li><a class="tocitem" href="../stdlib/Distributed.html">Distributed Computing</a></li><li><a class="tocitem" href="../stdlib/FileWatching.html">File Events</a></li><li><a class="tocitem" href="../stdlib/Future.html">Future</a></li><li><a class="tocitem" href="../stdlib/InteractiveUtils.html">Interactive Utilities</a></li><li><a class="tocitem" href="../stdlib/LibGit2.html">LibGit2</a></li><li><a class="tocitem" href="../stdlib/Libdl.html">Dynamic Linker</a></li><li><a class="tocitem" href="../stdlib/LinearAlgebra.html">Linear Algebra</a></li><li><a class="tocitem" href="../stdlib/Logging.html">Logging</a></li><li><a class="tocitem" href="../stdlib/Markdown.html">Markdown</a></li><li><a class="tocitem" href="../stdlib/Mmap.html">Memory-mapped I/O</a></li><li><a class="tocitem" href="../stdlib/Pkg.html">Pkg</a></li><li><a class="tocitem" href="../stdlib/Printf.html">Printf</a></li><li><a class="tocitem" href="../stdlib/Profile.html">Profiling</a></li><li><a class="tocitem" href="../stdlib/REPL.html">The Julia REPL</a></li><li><a class="tocitem" href="../stdlib/Random.html">Random Numbers</a></li><li><a class="tocitem" href="../stdlib/SHA.html">SHA</a></li><li><a class="tocitem" href="../stdlib/Serialization.html">Serialization</a></li><li><a class="tocitem" href="../stdlib/SharedArrays.html">Shared Arrays</a></li><li><a class="tocitem" href="../stdlib/Sockets.html">Sockets</a></li><li><a class="tocitem" href="../stdlib/SparseArrays.html">Sparse Arrays</a></li><li><a class="tocitem" href="../stdlib/Statistics.html">Statistics</a></li><li><a class="tocitem" href="../stdlib/Test.html">Unit Testing</a></li><li><a class="tocitem" href="../stdlib/UUIDs.html">UUIDs</a></li><li><a class="tocitem" href="../stdlib/Unicode.html">Unicode</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox" checked/><label class="tocitem" for="menuitem-6"><span class="docs-label">Developer Documentation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="reflection.html">Reflection and introspection</a></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox" checked/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Documentation of Julia&#39;s Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="init.html">Initialization of the Julia runtime</a></li><li><a class="tocitem" href="ast.html">Julia ASTs</a></li><li><a class="tocitem" href="types.html">More about types</a></li><li><a class="tocitem" href="object.html">Memory layout of Julia Objects</a></li><li><a class="tocitem" href="eval.html">Eval of Julia code</a></li><li><a class="tocitem" href="callconv.html">Calling Conventions</a></li><li><a class="tocitem" href="compiler.html">High-level Overview of the Native-Code Generation Process</a></li><li><a class="tocitem" href="functions.html">Julia Functions</a></li><li><a class="tocitem" href="cartesian.html">Base.Cartesian</a></li><li><a class="tocitem" href="meta.html">Talking to the compiler (the <code>:meta</code> mechanism)</a></li><li><a class="tocitem" href="subarrays.html">SubArrays</a></li><li><a class="tocitem" href="isbitsunionarrays.html">isbits Union Optimizations</a></li><li><a class="tocitem" href="sysimg.html">System Image Building</a></li><li><a class="tocitem" href="llvm.html">Working with LLVM</a></li><li><a class="tocitem" href="stdio.html">printf() and stdio in the Julia runtime</a></li><li><a class="tocitem" href="boundscheck.html">Bounds checking</a></li><li class="is-active"><a class="tocitem" href="locks.html">Proper maintenance and care of multi-threading locks</a><ul class="internal"><li><a class="tocitem" href="#Locks-1"><span>Locks</span></a></li><li><a class="tocitem" href="#Broken-Locks-1"><span>Broken Locks</span></a></li><li><a class="tocitem" href="#Shared-Global-Data-Structures-1"><span>Shared Global Data Structures</span></a></li></ul></li><li><a class="tocitem" href="offset-arrays.html">Arrays with custom indices</a></li><li><a class="tocitem" href="require.html">Module loading</a></li><li><a class="tocitem" href="inference.html">Inference</a></li><li><a class="tocitem" href="ssair.html">Julia SSA-form IR</a></li><li><a class="tocitem" href="gc-sa.html">Static analyzer annotations for GC correctness in C code</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-3" type="checkbox"/><label class="tocitem" for="menuitem-6-3"><span class="docs-label">Developing/debugging Julia&#39;s C code</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="backtraces.html">Reporting and analyzing crashes (segfaults)</a></li><li><a class="tocitem" href="debuggingtips.html">gdb debugging tips</a></li><li><a class="tocitem" href="valgrind.html">Using Valgrind with Julia</a></li><li><a class="tocitem" href="sanitizers.html">Sanitizer support</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer Documentation</a></li><li><a class="is-disabled">Documentation of Julia&#39;s Internals</a></li><li class="is-active"><a href="locks.html">Proper maintenance and care of multi-threading locks</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="locks.html">Proper maintenance and care of multi-threading locks</a></li></ul></nav>

<div class="docs-right">
<span style="text-align:center; font-face: JuliaMono-Regular";>JuliaMono edition</span>





<a class="docs-edit-link"
 href="https://github.com/JuliaLang/julia/blob/master/doc/src/devdocs/locks.md" title="Edit on GitHub"><span class="docs-icon fab"> ï</span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Proper-maintenance-and-care-of-multi-threading-locks-1"><a class="docs-heading-anchor" href="#Proper-maintenance-and-care-of-multi-threading-locks-1">Proper maintenance and care of multi-threading locks</a><a class="docs-heading-anchor-permalink" href="#Proper-maintenance-and-care-of-multi-threading-locks-1" title="Permalink"></a></h1><p>The following strategies are used to ensure that the code is dead-lock free (generally by addressing the 4th Coffman condition: circular wait).</p><blockquote><ol><li>structure code such that only one lock will need to be acquired at a time</li><li>always acquire shared locks in the same order, as given by the table below</li><li>avoid constructs that expect to need unrestricted recursion</li></ol></blockquote><h2 id="Locks-1"><a class="docs-heading-anchor" href="#Locks-1">Locks</a><a class="docs-heading-anchor-permalink" href="#Locks-1" title="Permalink"></a></h2><p>Below are all of the locks that exist in the system and the mechanisms for using them that avoid the potential for deadlocks (no Ostrich algorithm allowed here):</p><p>The following are definitely leaf locks (level 1), and must not try to acquire any other lock:</p><blockquote><ul><li><p>safepoint</p><blockquote><p>Note that this lock is acquired implicitly by <code>JL_LOCK</code> and <code>JL_UNLOCK</code>. use the <code>_NOGC</code> variants to avoid that for level 1 locks.</p><p>While holding this lock, the code must not do any allocation or hit any safepoints. Note that there are safepoints when doing allocation, enabling / disabling GC, entering / restoring exception frames, and taking / releasing locks.</p></blockquote></li><li><p>shared_map</p></li><li><p>finalizers</p></li><li><p>pagealloc</p></li><li><p>gc<em>perm</em>lock</p></li><li><p>flisp</p><blockquote><p>flisp itself is already threadsafe, this lock only protects the <code>jl_ast_context_list_t</code> pool</p></blockquote></li></ul></blockquote><p>The following is a leaf lock (level 2), and only acquires level 1 locks (safepoint) internally:</p><blockquote><ul><li>typecache</li></ul></blockquote><p>The following is a level 2 lock:</p><blockquote><ul><li>Module-&gt;lock</li></ul></blockquote><p>The following is a level 3 lock, which can only acquire level 1 or level 2 locks internally:</p><blockquote><ul><li>Method-&gt;writelock</li></ul></blockquote><p>The following is a level 4 lock, which can only recurse to acquire level 1, 2, or 3 locks:</p><blockquote><ul><li>MethodTable-&gt;writelock</li></ul></blockquote><p>No Julia code may be called while holding a lock above this point.</p><p>The following is a level 6 lock, which can only recurse to acquire locks at lower levels:</p><blockquote><ul><li>codegen</li></ul></blockquote><p>The following is an almost root lock (level end-1), meaning only the root look may be held when trying to acquire it:</p><blockquote><ul><li><p>typeinf</p><blockquote><p>this one is perhaps one of the most tricky ones, since type-inference can be invoked from many points</p><p>currently the lock is merged with the codegen lock, since they call each other recursively</p></blockquote></li></ul></blockquote><p>The following lock synchronizes IO operation. Be aware that doing any I/O (for example, printing warning messages or debug information) while holding any other lock listed above may result in pernicious and hard-to-find deadlocks. BE VERY CAREFUL!</p><blockquote><ul><li><p>iolock</p></li><li><p>Individual ThreadSynchronizers locks</p><blockquote><p>this may continue to be held after releasing the iolock, or acquired without it, but be very careful to never attempt to acquire the iolock while holding it</p></blockquote></li></ul></blockquote><p>The following is the root lock, meaning no other lock shall be held when trying to acquire it:</p><blockquote><ul><li><p>toplevel</p><blockquote><p>this should be held while attempting a top-level action (such as making a new type or defining a new method): trying to obtain this lock inside a staged function will cause a deadlock condition!</p><p>additionally, it&#39;s unclear if <em>any</em> code can safely run in parallel with an arbitrary toplevel expression, so it may require all threads to get to a safepoint first</p></blockquote></li></ul></blockquote><h2 id="Broken-Locks-1"><a class="docs-heading-anchor" href="#Broken-Locks-1">Broken Locks</a><a class="docs-heading-anchor-permalink" href="#Broken-Locks-1" title="Permalink"></a></h2><p>The following locks are broken:</p><ul><li><p>toplevel</p><blockquote><p>doesn&#39;t exist right now</p><p>fix: create it</p></blockquote></li></ul><h2 id="Shared-Global-Data-Structures-1"><a class="docs-heading-anchor" href="#Shared-Global-Data-Structures-1">Shared Global Data Structures</a><a class="docs-heading-anchor-permalink" href="#Shared-Global-Data-Structures-1" title="Permalink"></a></h2><p>These data structures each need locks due to being shared mutable global state. It is the inverse list for the above lock priority list. This list does not include level 1 leaf resources due to their simplicity.</p><p>MethodTable modifications (def, cache, kwsorter type) : MethodTable-&gt;writelock</p><p>Type declarations : toplevel lock</p><p>Type application : typecache lock</p><p>Global variable tables : Module-&gt;lock</p><p>Module serializer : toplevel lock</p><p>JIT &amp; type-inference : codegen lock</p><p>MethodInstance/CodeInstance updates : Method-&gt;writelock, codegen lock</p><blockquote><ul><li>These are set at construction and immutable:<ul><li>specTypes</li><li>sparam_vals</li><li>def</li></ul></li></ul></blockquote><blockquote><ul><li>These are set by <code>jl_type_infer</code> (while holding codegen lock):<ul><li>cache</li><li>rettype</li><li>inferred</li></ul></li></ul></blockquote><pre><code class="language-none">    * valid ages</code></pre><blockquote><ul><li><code>inInference</code> flag:<ul><li>optimization to quickly avoid recurring into <code>jl_type_infer</code> while it is already running</li><li>actual state (of setting <code>inferred</code>, then <code>fptr</code>) is protected by codegen lock</li></ul></li></ul></blockquote><blockquote><ul><li><p>Function pointers:</p><ul><li>these transition once, from <code>NULL</code> to a value, while the codegen lock is held</li></ul></li><li><p>Code-generator cache (the contents of <code>functionObjectsDecls</code>):</p><ul><li>these can transition multiple times, but only while the codegen lock is held</li><li>it is valid to use old version of this, or block for new versions of this, so races are benign, as long as the code is careful not to reference other data in the method instance (such as <code>rettype</code>) and assume it is coordinated, unless also holding the codegen lock</li></ul></li></ul></blockquote><p>LLVMContext : codegen lock</p><p>Method : Method-&gt;writelock</p><ul><li>roots array (serializer and codegen)</li><li>invoke / specializations / tfunc modifications</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="boundscheck.html">Â« Bounds checking</a><a class="docs-footer-nextpage" href="offset-arrays.html">Arrays with custom indices Â»</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 21 March 2020 14:49">Saturday 21 March 2020</span>. Using Julia version 1.4.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
